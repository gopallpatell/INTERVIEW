FINAL ARCHITECTURE (Understand First)
Application Pods
   â†“ (stdout logs)
Filebeat (DaemonSet)
   â†“
Elasticsearch
   â†“
Kibana
   â†‘
Nginx (Basic Auth â€“ username/password)
   â†‘
Browser




STEP 1: Deploy Elasticsearch (StatefulSet)
ğŸ“„ elasticsearch.yml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  namespace: logging
spec:
  serviceName: elasticsearch
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        env:
        - name: discovery.type
          value: single-node
        - name: xpack.security.enabled
          value: "false"
        ports:
        - containerPort: 9200

kubectl apply -f elasticsearch.yml

ğŸ”¹ STEP 2: Elasticsearch Service
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  namespace: logging
spec:
  selector:
    app: elasticsearch
  ports:
  - port: 9200

ğŸ”¹ STEP 3: Deploy Kibana
ğŸ“„ kibana.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kibana
  namespace: logging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kibana
  template:
    metadata:
      labels:
        app: kibana
    spec:
      containers:
      - name: kibana
        image: docker.elastic.co/kibana/kibana:8.11.0
        env:
        - name: ELASTICSEARCH_HOSTS
          value: http://elasticsearch:9200
        ports:
        - containerPort: 5601

ğŸ”¹ STEP 4: Kibana Service (Internal Only)
apiVersion: v1
kind: Service
metadata:
  name: kibana
  namespace: logging
spec:
  selector:
    app: kibana
  ports:
  - port: 5601


ğŸš« Do NOT expose Kibana publicly

ğŸ”¹ STEP 5: Install Filebeat (DaemonSet â€“ IMPORTANT)
ğŸ“„ filebeat.yml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
  namespace: logging
spec:
  selector:
    matchLabels:
      app: filebeat
  template:
    metadata:
      labels:
        app: filebeat
    spec:
      serviceAccountName: filebeat
      containers:
      - name: filebeat
        image: docker.elastic.co/beats/filebeat:8.11.0
        args: ["-c", "/etc/filebeat.yml", "-e"]
        volumeMounts:
        - name: config
          mountPath: /etc/filebeat.yml
          subPath: filebeat.yml
        - name: varlog
          mountPath: /var/log
        - name: containers
          mountPath: /var/lib/docker/containers
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: filebeat-config
      - name: varlog
        hostPath:
          path: /var/log
      - name: containers
        hostPath:
          path: /var/lib/docker/containers

ğŸ“„ Filebeat ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: logging
data:
  filebeat.yml: |
    filebeat.autodiscover:
      providers:
        - type: kubernetes
          hints.enabled: true

    output.elasticsearch:
      hosts: ["http://elasticsearch:9200"]

ğŸ”¹ STEP 6: Filebeat Permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: filebeat
  namespace: logging

ğŸ”¹ STEP 7: Verify Logs
kubectl logs -n logging -l app=filebeat


Logs should be flowing now ğŸš€

ğŸ” STEP 8: Secure Kibana Using Nginx (USERNAME / PASSWORD)
8ï¸âƒ£.1 Create htpasswd
htpasswd -c htpasswd kibanaadmin

8ï¸âƒ£.2 Create Secret
kubectl create secret generic kibana-auth \
--from-file=htpasswd \
-n logging

8ï¸âƒ£.3 Nginx ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: logging
data:
  default.conf: |
    server {
      listen 80;

      auth_basic "Restricted Kibana";
      auth_basic_user_file /etc/nginx/htpasswd;

      location / {
        proxy_pass http://kibana:5601;
      }
    }

8ï¸âƒ£.4 Deploy Nginx
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-kibana
  namespace: logging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-kibana
  template:
    metadata:
      labels:
        app: nginx-kibana
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        volumeMounts:
        - name: config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        - name: auth
          mountPath: /etc/nginx/htpasswd
          subPath: htpasswd
      volumes:
      - name: config
        configMap:
          name: nginx-config
      - name: auth
        secret:
          secretName: kibana-auth

8ï¸âƒ£.5 Expose Nginx
apiVersion: v1
kind: Service
metadata:
  name: nginx-kibana
  namespace: logging
spec:
  type: NodePort
  selector:
    app: nginx-kibana
  ports:
  - port: 80
    nodePort: 30080

ğŸ”¹ STEP 9: Access Secure Kibana
http://<NodeIP>:30080


âœ” Browser asks username/password
âœ” Login â†’ Kibana opens
âœ” Logs visible ğŸ‰
